{% extends "procurement/base.html" %}
{% load humanize dict_extras %}

{% block content %}
<div class="container mt-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-0 text-maroon fw-bold">Abstract of Quotation</h2>

      <!-- PRINT PREVIEW BUTTON -->
      <a href="javascript:window.print()" class="btn btn-maroon">
        Print Preview
      </a>
  </div>

  <!-- PR NUMBERS SECTION -->
  <p><strong>Purchase Request:</strong>
    {% if rfq.purchase_request %}
      {{ rfq.purchase_request.pr_number }}
    {% elif rfq.consolidated_prs.all %}
      {% for pr in rfq.consolidated_prs.all %}
        {{ pr.pr_number }}{% if not forloop.last %}, {% endif %}
      {% endfor %}
    {% endif %}
  </p>

  {% with suppliers_count=suppliers|length %}
    {% widthratio suppliers_count 1 2 as supplier_cols %}
    {% widthratio supplier_cols 1 4 as colspan %}

  <div class="table-responsive mt-4">
    <table class="table table-bordered align-middle text-right">
      <thead class="table-light">
        <tr>
          <th class="text-center">Stock No.</th>
          <th class="text-start">Item Description</th>
          <th class="text-center">Unit</th>
          <th class="text-center">Quantity</th>
          {% for supplier in suppliers %}
            <th colspan="2" class="text-center">{{ supplier.name }}</th>
          {% endfor %}
        </tr>
      </thead>

      <tbody>

        {% if rfq.consolidated_prs.exists %}
          {# CONSOLIDATED AOQ LAYOUT #}

          {% regroup items by purchase_request as pr_groups %}

          {% for group in pr_groups %}
            <!-- PR GROUP HEADER -->
            <tr class="table-light fw-bold">
              <td colspan="{{ colspan }}" class="text-maroon">
                PR No. {{ group.grouper.pr_number|default:"(Unassigned)" }}
              </td>
            </tr>

            {% for item in group.list %}
              <tr>
                <td class="text-center">{{ item.stock_no }}</td>
                <td class="preserve-whitespace">{{ item.description }}</td>
                <td class="text-center">{{ item.unit }}</td>
                <td class="text-center">{{ item.quantity }}</td>

                {% for supplier in suppliers %}
                  {% with line=supplier_data|get_item:supplier|get_item:item.id %}
                    {% if line %}
                      <td class="text-center">{{ line.offer }}</td>
                      <td class="text-end">{{ line.unit_price|floatformat:2|intcomma }}</td>
                    {% else %}
                      <td></td><td></td>
                    {% endif %}
                  {% endwith %}
                {% endfor %}
              </tr>
            {% endfor %}
          {% endfor %}

        {% else %}
          {# SINGLE PR AOQ LAYOUT #}

          {% for item in items %}
            <tr>
              <td class="text-center">{{ item.stock_no }}</td>
              <td class="preserve-whitespace">{{ item.description }}</td>
              <td class="text-center">{{ item.unit }}</td>
              <td class="text-center">{{ item.quantity }}</td>

              {% for supplier in suppliers %}
                {% with line=supplier_data|get_item:supplier|get_item:item.id %}
                  {% if line %}
                    <td class="text-center">{{ line.offer }}</td>
                    <td class="text-end">{{ line.unit_price|floatformat:2|intcomma }}</td>
                  {% else %}
                    <td></td><td></td>
                  {% endif %}
                {% endwith %}
              {% endfor %}
            </tr>
          {% endfor %}
        {% endif %}

      </tbody>
    </table>
  </div>
  {% endwith %}

  <!-- BACK BUTTON -->
  <div class="mt-3 mb-4">
    <a href="javascript:history.back()" class="btn btn-outline-maroon">← Back</a>
  </div>
<hr class="my-4">

<h4 class="text-maroon fw-bold mb-3">Recommended for Purchase on Quotations of:</h4>

<div class="row text-center mb-4">

  <div class="col-md-4 mb-4">
    <p class="fw-bold mb-0 text-uppercase">DORIS ANN S. ESPINA, CPA, CSEE, Ph.D., JD</p>
    <p class="small mb-0">Regular Member</p>
  </div>

  <div class="col-md-4 mb-4">
    <p class="fw-bold mb-0 text-uppercase">VILMAR SILVANO A. SOLIS, CPA</p>
    <p class="small mb-0">Regular Member</p>
  </div>

  <div class="col-md-4 mb-4">
    <p class="fw-bold mb-0 text-uppercase">ATTY. RODOLPH B. HERNANDEZ, JR.</p>
    <p class="small mb-0">Regular Member</p>
  </div>
</div>

<div class="row text-center mb-4">

  <div class="col-md-6 mb-4">
    <p class="fw-bold mb-0 text-uppercase">DR. MARICHU S. ARMADA</p>
    <p class="small mb-0">Provisional BAC Member – Expert</p>
  </div>

  <div class="col-md-6 mb-4">
    <p class="fw-bold mb-0 text-uppercase">DANILO B. PULMA, DM</p>
    <p class="small mb-0">Provisional BAC Member – End-user</p>
  </div>

</div>

<hr class="my-4">

<div class="row text-center mb-5">

  <div class="col-md-4 mb-4">
    <p class="fw-bold mb-0 text-uppercase">ANALYN C. ESPAÑO, DA</p>
    <p class="small mb-0">BAC Vice-Chairperson</p>
  </div>

  <div class="col-md-4 mb-4">
    <p class="fw-bold mb-0 text-uppercase">LYDIA M. MORANTE, DA</p>
    <p class="small mb-0">BAC Chairperson</p>
  </div>

  <div class="col-md-4 mb-4">
    <p class="fw-bold mb-0 text-uppercase">DENNIS C. DE PAZ, Ph.D.</p>
    <p class="small mb-0">University President</p>
  </div>

</div>

</div>

<style>
  th, td { vertical-align: middle; }
  .table th[colspan="2"] { background-color: #f8f9fa; }
  .btn-outline-maroon {
    border: 1px solid #800000;
    color: #800000;
  }
  .btn-outline-maroon:hover {
    background-color: #800000;
    color: white;
  }
  .btn-maroon {
    background-color: #800000;
    color: white;
    border: 1px solid #800000;
  }
  .btn-maroon:hover {
    background-color: #a00000;
    color: white;
  }
  .preserve-whitespace { white-space: pre-wrap; word-break: break-word; }

  /* Print Styling */
  @media print {
    .btn, a { display: none !important; }
    .table th, .table td { font-size: 12px; }
  }

.signatory-name {
  text-transform: uppercase;
  font-weight: bold;
  margin-bottom: 0;
}

.signatory-title {
  font-size: 0.85rem;
  margin-top: 0;
}

@media print {
  .signatory-title { font-size: 10px; }
  .signatory-name { font-size: 12px; }
}

</style>

{% endblock %}
