{% extends "procurement/base.html" %}
{% load humanize dict_extras %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-3">Abstract of Quotation</h2>
  
<p><strong>Purchase Request:</strong>
  {% if rfq.purchase_request %}
    {{ rfq.purchase_request.pr_number }}
  {% elif rfq.consolidated_prs.all %}
    {% for pr in rfq.consolidated_prs.all %}
      {{ pr.pr_number }}{% if not forloop.last %}, {% endif %}
    {% endfor %}
  {% endif %}
</p>



  {% with suppliers_count=suppliers|length %}
  {% widthratio suppliers_count 1 2 as supplier_cols %}
  {% widthratio supplier_cols 1 4 as colspan %}

  <div class="table-responsive mt-4">
    <table class="table table-bordered align-middle text-right">
      <thead class="table-light">
        <tr>
          <th class="text-center">Stock No.</th>
          <th class="text-start">Item Description</th>
          <th class="text-center">Unit</th>
          <th class="text-center">Quantity</th>
          {% for supplier in suppliers %}
            <th colspan="2" class="text-center">{{ supplier.name }}</th>
          {% endfor %}
        </tr>
      </thead>

      <tbody>

        {% if rfq.consolidated_prs.exists %}
          {# -------------------------- #}
          {#   CONSOLIDATED RFQ MODE   #}
          {# -------------------------- #}

          {% regroup items by purchase_request as pr_groups %}

          {% for group in pr_groups %}
            <!-- PR HEADER ROW -->
            <tr class="table-light fw-bold">
              <td colspan="{{ colspan }}" class="text-maroon">
                PR No. {{ group.grouper.pr_number|default:"(Unassigned)" }}
              </td>
            </tr>

            {% for item in group.list %}
              <tr>
                <td class="text-center">{{ item.stock_no }}</td>
                <td class="preserve-whitespace">{{ item.description }}</td>
                <td class="text-center">{{ item.unit }}</td>
                <td class="text-center">{{ item.quantity }}</td>

                {% for supplier in suppliers %}
                  {% with line=supplier_data|get_item:supplier|get_item:item.id %}
                    {% if line %}
                      <td class="text-center">{{ line.offer|default_if_none:"" }}</td>
                      <td class="text-end">{{ line.unit_price|floatformat:2|intcomma }}</td>
                    {% else %}
                      <td></td><td></td>
                    {% endif %}
                  {% endwith %}
                {% endfor %}
              </tr>
            {% endfor %}
          {% endfor %}

        {% else %}
          {# -------------------------- #}
          {#     SINGLE PR MODE        #}
          {# -------------------------- #}

          {% for item in items %}
            <tr>
              <td class="text-center">{{ item.stock_no }}</td>
              <td class="preserve-whitespace">{{ item.description }}</td>
              <td class="text-center">{{ item.unit }}</td>
              <td class="text-center">{{ item.quantity }}</td>

              {% for supplier in suppliers %}
                {% with line=supplier_data|get_item:supplier|get_item:item.id %}
                  {% if line %}
                    <td class="text-center">{{ line.offer|default_if_none:"" }}</td>
                    <td class="text-end">{{ line.unit_price|floatformat:2|intcomma }}</td>
                  {% else %}
                    <td></td><td></td>
                  {% endif %}
                {% endwith %}
              {% endfor %}
            </tr>
          {% endfor %}
        {% endif %}

      </tbody>
    </table>
  </div>

{% endwith %}

    <div class="d-flex justify-content-between align-items-center mt-3 mb-3">
    <!-- Back button (left) -->
    <a href="javascript:history.back()" class="btn btn-outline-maroon">‚Üê Back</a>

    <!-- AOQ Preview button (right) -->
    <a href="{% url 'procurement:aoq_preview' rfq.id %}" class="btn btn-maroon">
        Print
    </a>
</div>
  </div>
</div>

<style>
  th, td { vertical-align: middle; }
  .table th[colspan="2"] { background-color: #f8f9fa; }
  .btn-outline-maroon {
    border: 1px solid #800000;
    color: #800000;
  }
  .btn-outline-maroon:hover {
    background-color: #800000;
    color: white;
  }

  .nowrap {
  white-space: nowrap !important;
}

.center { text-align: center; }
.right { text-align: right; }
.fw-bold { font-weight: bold; }
.nowrap { white-space: nowrap; }
.preserve-whitespace { white-space: pre-wrap; word-break: break-word; }

.btn-maroon {
    background-color: #800000;
    color: white;
    border: 1px solid #800000;
}

.btn-maroon:hover {
    background-color: #a00000;
    border-color: #a00000;
    color: white;
}

</style>
{% endblock %}
