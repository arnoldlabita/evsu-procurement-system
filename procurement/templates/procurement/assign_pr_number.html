{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Assign PR Number — EVSU Procurement</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{ --maroon:#800000; --muted:#6c757d; }
    body{ background:#f4f5f7; font-family:'Segoe UI',sans-serif; padding:20px; }
    .pr-card{ background:#fff; max-width:900px; margin:0 auto; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,0.05); padding:20px; }
    .pr-header{ display:flex; gap:16px; align-items:center; border-bottom:6px solid var(--maroon); padding-bottom:8px; }
    .pr-header img{ width:80px; height:auto; }
    .pr-header h1{ color:var(--maroon); font-size:22px; margin:0; }
    input,select,textarea{ width:100%; border:1px solid #ccc; border-radius:4px; padding:6px 8px; font-size:14px; }
    .btn-maroon{ background:var(--maroon); color:#fff; border:none; }
    .btn-outline-maroon{ color:var(--maroon); border:1px solid var(--maroon); }
    .alert-error{ background:#ffecec; border:1px solid #ffb3b3; color:#b30000; border-radius:4px; padding:10px; margin-top:10px; }
    @media print{ .no-print{display:none!important;} body{background:white;} .pr-card{box-shadow:none;} }
  </style>
</head>
<body>

<div class="pr-card">
  <div class="pr-header">
    <img src="{% static 'procurement/evsu-logo.png' %}" alt="EVSU Logo">
    <h1>ASSIGN PR NUMBER & DATE</h1>
  </div>

  <form method="post" action="{% url 'procurement:assign_pr_number' pr.id %}" enctype="multipart/form-data" novalidate>
    {% csrf_token %}

    <!-- ✅ Display messages (success/info/warning) -->
    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} mt-2">{{ message }}</div>
      {% endfor %}
    {% endif %}

    <!-- ✅ Display form-wide errors only ONCE -->
    {% if form.non_field_errors %}
      <div class="alert-error">
        {{ form.non_field_errors }}
      </div>
    {% endif %}

    <h5 class="mt-3">Purchase Request Details</h5>
    <div class="row mt-2">
      <div class="col-md-6 mb-2">
        <label class="form-label">Requisitioner</label>
        <input type="text" class="form-control" value="{{ pr.requisitioner }}" readonly>
      </div>
      <div class="col-md-6 mb-2">
        <label class="form-label">Office / Section</label>
        <input type="text" class="form-control" value="{{ pr.office_section }}" readonly>
      </div>
    </div>

    <div class="row mt-2">
      <div class="col-md-6 mb-2">
        <label class="form-label">Designation</label>
        <input type="text" class="form-control" value="{{ pr.designation }}" readonly>
      </div>
      <div class="col-md-6 mb-2">
        <label class="form-label">Funding</label>
        <input type="text" class="form-control" value="{{ pr.get_funding_display }}" readonly>
      </div>
    </div>

    <div class="mt-2">
      <label class="form-label">Purpose</label>
      <textarea class="form-control" rows="2" readonly>{{ pr.purpose }}</textarea>
    </div>

    <h5 class="mt-4">Assign PR Number & Date</h5>
    <div class="row mt-2">
      <div class="col-md-6 mb-2">
        {{ form.pr_number.label_tag }}
        {{ form.pr_number }}
        {% if form.pr_number.errors %}
          <div class="alert-error">{{ form.pr_number.errors }}</div>
        {% endif %}
      </div>
      <div class="col-md-6 mb-2">
        {{ form.pr_date.label_tag }}
        {{ form.pr_date }}
        {% if form.pr_date.errors %}
          <div class="alert-error">{{ form.pr_date.errors }}</div>
        {% endif %}
      </div>
    </div>

    <div class="d-flex justify-content-end mt-3">
      <button type="submit" class="btn btn-maroon btn-sm">Save PR Number & Date</button>
    </div>
  </form>

  <h5 class="mt-4">PR Items</h5>
  <table class="table table-bordered">
    <thead class="table-dark">
      <tr>
        <th>#</th>
        <th>Description</th>
        <th>Quantity</th>
        <th>Unit</th>
        <th>Unit Cost (₱)</th>
        <th>Total (₱)</th>
      </tr>
    </thead>
    <tbody>
      {% for item in pr.items.all %}
      <tr>
        <td>{{ forloop.counter }}</td>
        <td>{{ item.description }}</td>
        <td>{{ item.quantity }}</td>
        <td>{{ item.unit }}</td>
        <td>{{ item.unit_cost|floatformat:2 }}</td>
        <td>{{ item.total_cost|floatformat:2 }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="6" class="text-center text-muted">No items found.</td></tr>
      {% endfor %}
    </tbody>
  </table>

  {% if pr.attachments %}
  <div class="mt-3">
    <label class="form-label">Attachment:</label><br>
    <a href="{{ pr.attachments.url }}" target="_blank">{{ pr.attachments.name }}</a>
  </div>
  {% endif %}
</div>

</body>
</html>
