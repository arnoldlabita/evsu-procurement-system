{% extends "procurement/base.html" %}
{% load group_tags %}
{% load humanize %}
{% load tz %}
{% block content %}

<div class="container mt-4">
  <h2 class="text-maroon fw-bold">
    Purchase Request {{ pr.pr_number|default:"(Unassigned)" }}
  </h2>

  <div class="card shadow-sm p-3 mb-3">
    <p><strong>Requisitioner:</strong> {{ pr.requisitioner }}</p>
    <p><strong>Designation:</strong> {{ pr.designation }}</p>
    <p><strong>Office/Section:</strong> {{ pr.office_section }}</p>
    <p><strong>Funding:</strong> {{ pr.funding }}</p>
    <p><strong>Purpose:</strong> {{ pr.purpose }}</p>
    {% if pr.attachments %}
      <p><strong>Attachment:</strong>
        <a href="{{ pr.attachments.url }}" target="_blank" class="text-maroon">View File</a>
      </p>
    {% endif %}
  </div>

  <p>
    <strong>Status:</strong>
    <span class="badge 
      {% if pr.status == 'verified' %}bg-success
      {% elif pr.status == 'submitted' %}bg-primary
      {% else %}bg-secondary{% endif %}">
      {{ pr.status|capfirst }}
    </span>
  </p>

  <div class="table-responsive">
    <table class="table table-bordered align-middle" style="table-layout: auto;">
      <thead class="table-maroon text-white text-center">
        <tr>
            <th>Stock No.</th>
            <th>Unit</th>
            <th>Item Description</th>
            <th>Qty</th>
            <th class="text-end">Unit Cost</th>
            <th class="text-end">Total Cost</th>
        </tr>
      </thead>
      <tbody>
        {% for item in pr.items.all %}
          <tr>
            <td class="text-center">{{ forloop.counter }}</td>
            <td class="text-center">{{ item.unit }}</td>
            <td class="preserve-whitespace">{{ item.description }}</td>
            <td class="text-center">{{ item.quantity|floatformat:0|intcomma }}</td>
            <td class="text-end">{{ item.unit_cost|floatformat:2|intcomma }}</td>
            <td class="text-end">{{ item.total_cost|floatformat:2|intcomma }}</td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="6" class="text-center text-muted">No items found for this PR.</td>
          </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <td colspan="5" class="text-end fw-bold">Grand Total (‚Ç±)</td>
          <td class="text-end fw-bold">‚Ç± {{ grand_total|floatformat:2|intcomma }}</td>
        </tr>
      </tfoot>
    </table>
  </div>

  <div class="mt-3 d-flex flex-wrap gap-2 no-print">
    {% if user|has_group:"Requisitioner" %}
    {% if pr.status == 'draft' %}
    <a href="{% url 'procurement:pr_edit' pr.pk %}" class="btn btn-outline-maroon">Edit Request</a>
    <form method="post" action="{% url 'procurement:submit_pr' pr.pk %}" style="display:inline;">
    {% csrf_token %}
    <button type="submit" class="btn btn-maroon">Submit for Verification</button>
    </form>
    {% endif %}
    {% endif %}

  {% if user|has_group:"Procurement" %}
  {% if not pr.pr_number %}
    <a href="{% url 'procurement:assign_pr_number' pr.pk %}" class="btn btn-success">Assign PR Number</a>
  {% endif %}

    <a href="{% url 'procurement:create_rfq' pr.pk %}" class="btn btn-outline-maroon">Create RFQ</a>
    <a href="{% url 'procurement:create_apr' pr.pk %}" class="btn btn-outline-maroon">Create APR</a>
  {% endif %}

  {% if user|has_group:"Procurement" %}
  <a href="{% url 'procurement:assign_pr_number' pr.pk %}" class="btn btn-outline-maroon">Edit PR</a>
  {% endif %}

    <!-- ‚úÖ Print Button appears only if PR number exists -->
    {% if pr.pr_number %}
    <button 
      class="btn btn-secondary"
      data-url="{% url 'procurement:pr_preview' pr.pk %}?auto_print=false"
      data-title="Purchase Request Preview"
      onclick="openDocPreview(this.dataset.url, this.dataset.title)">
      üñ®Ô∏è Print PR
    </button>
    {% else %}
      <button class="btn btn-secondary" disabled title="Assign PR number first">
        üñ®Ô∏è Print PR
      </button>
    {% endif %}
  </div>

  {% if user|has_group:"Procurement" and pr.notes %}
  <!-- ‚úÖ Move this OUTSIDE the flexbox -->
  <div class="mt-2">
    <p class="mb-0"><strong>Last Update:</strong> {{ pr.last_update|localtime|date:"M d, Y h:i A" }}</p>
  </div>
  {% endif %}
  {% if pr.consolidated_in %}
  <p><strong>Consolidated in RFQ:</strong>
     <a href="{% url 'procurement:rfq_detail' pr.consolidated_in.id %}">
       {{ pr.consolidated_in.rfq_number }}
     </a>
  </p>
{% endif %}
</div>



<!-- ‚úÖ Modal for Document Preview -->
<div class="modal fade" id="docPreviewModal" tabindex="-1" aria-labelledby="docPreviewLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered" style="max-width: 90%;">
    <div class="modal-content">
      <div class="modal-header bg-maroon text-white">
        <h5 class="modal-title" id="docPreviewLabel">Document Preview</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">
        <iframe id="docPreviewFrame" src="" style="width:100%; height:80vh; border:none;" title="Document Preview"></iframe>
      </div>
      <div class="modal-footer justify-content-between">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-outline-maroon" onclick="printPreview()">üñ®Ô∏è Print</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ JavaScript for Modal -->
<script>
function openDocPreview(url, title = "Document Preview") {
  const modalTitle = document.getElementById("docPreviewLabel");
  const iframe = document.getElementById("docPreviewFrame");
  modalTitle.textContent = title;
  iframe.src = url;

  const modal = new bootstrap.Modal(document.getElementById('docPreviewModal'));
  modal.show();
}

function printPreview() {
  const iframe = document.getElementById("docPreviewFrame");
  iframe.contentWindow.focus();
  iframe.contentWindow.print();
}
</script>

<!-- ‚úÖ Custom Styles -->
<style>
.text-maroon { color: #800000; }
.btn-maroon { background-color: #800000; color: white; border: none; }
.btn-maroon:hover { background-color: #a30000; }
.btn-outline-maroon { border: 1px solid #800000; color: #800000; }
.btn-outline-maroon:hover { background-color: #800000; color: white; }
.table-maroon { background-color: #800000; }

.modal-backdrop.show {
  opacity: 0.85 !important;
  background-color: rgba(0, 0, 0, 0.6);
}

.modal-content {
  border-radius: 1rem;
  overflow: hidden;
  box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
  transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
}

.modal.fade .modal-dialog {
  transform: translateY(-20px);
  transition: transform 0.3s ease-out;
}

.modal.show .modal-dialog {
  transform: translateY(0);
}

.bg-maroon {
  background-color: #800000 !important;
}

@media (max-width: 768px) {
  #docPreviewFrame {
    height: 70vh;
  }
}

@media print {
  .btn, .no-print, .navbar, footer { display: none !important; }
  body { background: white; }
}

.btn, a.btn {
  display: inline-flex !important;
  align-items: center;
  justify-content: center;
  font-family: inherit;
  font-weight: 500;
  font-size: 15px;
  line-height: 1.2;
  padding: 10px 16px;
  border-radius: 6px;
  border-width: 1px !important;
  box-sizing: border-box;
  height: 44px;
  min-width: 180px;
  text-decoration: none !important;
  white-space: nowrap;
}

/* ‚úÖ Make buttons share equal width per row */
.no-print {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.no-print .btn {
  flex: 1 1 200px; /* equal width auto-adjust per row */
  max-width: 160px;
}

/* Secondary button consistent height */
.btn-secondary {
  background-color: #6c757d;
  color: white;
  border: none;
}
.btn-secondary:hover {
  background-color: #5a6268;
}
.preserve-whitespace {
  white-space: pre-wrap;
}
</style>

{% endblock %}
