{% extends "procurement/base.html" %}
{% load humanize %}
{% load tz %}
{% load group_tags %}

{% block content %}
<h2 class="text-maroon fw-bold mt-3">Purchase Requests</h2>

<form method="get" class="row g-2 align-items-end mb-3">

  {% if is_procurement %}
  <!-- Assigned Status Filter -->
  <div class="col-md-3">
    <label class="form-label small fw-bold text-muted">Assigned Status</label>
    <select name="assigned" class="form-select form-select-sm">
      <option value="">All</option>
      <option value="assigned" {% if assigned_filter == "assigned" %}selected{% endif %}>Assigned</option>
      <option value="unassigned" {% if assigned_filter == "unassigned" %}selected{% endif %}>Unassigned</option>
    </select>
  </div>
  {% endif %}

  <!-- PR Number Search (All users) -->
  <div class="col-md-3">
    <label class="form-label small fw-bold text-muted">PR Number</label>
    <input 
      type="text" 
      name="pr_number" 
      value="{{ pr_number_search }}" 
      class="form-control form-control-sm"
      placeholder="Search PR no.">
  </div>

  {% if is_procurement %}
  <!-- Office Filter -->
  <div class="col-md-3">
    <label class="form-label small fw-bold text-muted">Office</label>
    <select name="office" class="form-select form-select-sm">
      <option value="">All</option>
      {% for office in offices %}
        <option value="{{ office }}" {% if office_filter == office %}selected{% endif %}>
          {{ office }}
        </option>
      {% endfor %}
    </select>
  </div>
  {% endif %}

  <!-- Filter + Reset Buttons -->
  <div class="col-md-2">
    <button type="submit" class="btn btn-maroon btn-sm w-100">Filter</button>
  </div>
  <div class="col-md-1">
    <a href="{% url 'procurement:pr_list' %}" class="btn btn-outline-secondary btn-sm w-100">Reset</a>
  </div>

</form>



<table id="pr-table" class="table table-bordered align-middle mt-3 shadow-sm">
  <thead class="table-maroon text-white">
    <tr>
      <th>PR No.</th>
      <th>Requesting Office</th>
      <th>Status</th>
      <th>Mode of Procurement</th>
      <th>Last Update</th>
      <th class="text-center">Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for pr in prs %}
    <tr id="pr-row-{{ pr.pk }}">
      <td>{{ pr.pr_number|default:"Unassigned" }}</td>
      <td>{{ pr.office_section }}</td>

      <!-- ✅ STATUS COLUMN -->
      <td class="status-column">
        {% if user|has_group:"Procurement" or user|has_group:"Admin" %}
          <select class="form-select form-select-sm status-select"
                  data-pr-id="{{ pr.pk }}"
                  data-current="{{ pr.status|default:'' }}"
                  data-mode="{{ pr.mode_of_procurement|default:'' }}">
          </select>
        {% else %}
          <span class="badge
            {% if pr.status == 'verified' %}bg-success
            {% elif pr.status == 'submitted' %}bg-primary
            {% elif pr.status == 'closed' %}bg-secondary
            {% else %}bg-warning text-dark{% endif %}">
            {{ pr.get_status_display }}
          </span>
        {% endif %}
      </td>

      <!-- ✅ MODE OF PROCUREMENT COLUMN -->
      <td class="mode-column">
        {% if user|has_group:"Procurement" or user|has_group:"Admin" %}
          <select name="mode_of_procurement"
                  class="form-select form-select-sm mode-select"
                  data-pr-id="{{ pr.pk }}"
                  data-sub-select-id="submode-{{ pr.pk }}">
            <option value="">— Select Mode —</option>
            <option value="Competitive Bidding" {% if pr.mode_of_procurement == "Competitive Bidding" %}selected{% endif %}>Competitive Bidding</option>
            <option value="Limited Source Bidding" {% if pr.mode_of_procurement == "Limited Source Bidding" %}selected{% endif %}>Limited Source Bidding</option>
            <option value="Competitive Dialogue" {% if pr.mode_of_procurement == "Competitive Dialogue" %}selected{% endif %}>Competitive Dialogue</option>
            <option value="Unsolicited Offer with Bid Matching" {% if pr.mode_of_procurement == "Unsolicited Offer with Bid Matching" %}selected{% endif %}>Unsolicited Offer with Bid Matching</option>
            <option value="Direct Contracting" {% if pr.mode_of_procurement == "Direct Contracting" %}selected{% endif %}>Direct Contracting</option>
            <option value="Direct Acquisition" {% if pr.mode_of_procurement == "Direct Acquisition" %}selected{% endif %}>Direct Acquisition</option>
            <option value="Repeat Order" {% if pr.mode_of_procurement == "Repeat Order" %}selected{% endif %}>Repeat Order</option>
            <option value="Small Value Procurement" {% if pr.mode_of_procurement == "Small Value Procurement" %}selected{% endif %}>Small Value Procurement</option>
            <option value="Negotiated Procurement" {% if pr.mode_of_procurement == "Negotiated Procurement" %}selected{% endif %}>Negotiated Procurement</option>
            <option value="Direct Sales" {% if pr.mode_of_procurement == "Direct Sales" %}selected{% endif %}>Direct Sales</option>
            <option value="Direct Procurement for Science, Technology and Innovation" {% if pr.mode_of_procurement == "Direct Procurement for Science, Technology and Innovation" %}selected{% endif %}>Direct Procurement for Science, Technology and Innovation</option>
          </select>

          <!-- ✅ Negotiated Procurement Subtype -->
          <select name="negotiated_type"
                  id="submode-{{ pr.pk }}"
                  class="form-select form-select-sm mt-1 submode-select"
                  data-pr-id="{{ pr.pk }}"
                  {% if pr.mode_of_procurement != "Negotiated Procurement" %}style="display:none;"{% endif %}>
            <option value="">— Select Sub-Type —</option>
            <option value="Two Failed Biddings" {% if pr.negotiated_type == "Two Failed Biddings" %}selected{% endif %}>Two Failed Biddings</option>
            <option value="Emergency Cases" {% if pr.negotiated_type == "Emergency Cases" %}selected{% endif %}>Emergency Cases</option>
            <option value="Take-over of Contracts" {% if pr.negotiated_type == "Take-over of Contracts" %}selected{% endif %}>Take-over of Contracts</option>
            <option value="Adjacent or Contiguous" {% if pr.negotiated_type == "Adjacent or Contiguous" %}selected{% endif %}>Adjacent or Contiguous</option>
            <option value="Agency-to-Agency" {% if pr.negotiated_type == "Agency-to-Agency" %}selected{% endif %}>Agency-to-Agency</option>
            <option value="Scientific, Scholarly or Artistic Work, Exclusive Technology and Media Services" {% if pr.negotiated_type == "Scientific, Scholarly or Artistic Work, Exclusive Technology and Media Services" %}selected{% endif %}>Scientific, Scholarly or Artistic Work, Exclusive Technology and Media Services</option>
            <option value="Highly Technical Consultants" {% if pr.negotiated_type == "Highly Technical Consultants" %}selected{% endif %}>Highly Technical Consultants</option>
            <option value="Defense Cooperation Agreements and Inventory-Based Items" {% if pr.negotiated_type == "Defense Cooperation Agreements and Inventory-Based Items" %}selected{% endif %}>Defense Cooperation Agreements and Inventory-Based Items</option>
            <option value="Lease of Real Property and Venue" {% if pr.negotiated_type == "Lease of Real Property and Venue" %}selected{% endif %}>Lease of Real Property and Venue</option>
            <option value="Non-Government Organization (NGO) Participation" {% if pr.negotiated_type == "Non-Government Organization (NGO) Participation" %}selected{% endif %}>Non-Government Organization (NGO) Participation</option>
            <option value="Community Participation" {% if pr.negotiated_type == "Community Participation" %}selected{% endif %}>Community Participation</option>
            <option value="United Nations (UN) Agencies, International Organizations or International Financing Institutions" {% if pr.negotiated_type == "United Nations (UN) Agencies, International Organizations or International Financing Institutions" %}selected{% endif %}>United Nations (UN) Agencies, International Organizations or International Financing Institutions</option>
            <option value="Direct Retail Purchase of Petroleum Fuel, Oil and Lubricant Products, Electronic Charging Devices, and Online Subscriptions" {% if pr.negotiated_type == "Direct Retail Purchase of Petroleum Fuel, Oil and Lubricant Products, Electronic Charging Devices, and Online Subscriptions" %}selected{% endif %}>Direct Retail Purchase of Petroleum Fuel, Oil and Lubricant Products, Electronic Charging Devices, and Online Subscriptions</option>
          </select>
        {% else %}
          <span title="{{ pr.mode_of_procurement }}{% if pr.negotiated_type %} - {{ pr.negotiated_type }}{% endif %}">
            {{ pr.mode_of_procurement }}
            {% if pr.mode_of_procurement == "Negotiated Procurement" and pr.negotiated_type %}
              <br><small class="text-muted">{{ pr.negotiated_type }}</small>
            {% endif %}
          </span>
        {% endif %}
      </td>

      <td class="update-cell">{{ pr.last_update|localtime|date:"M d, Y h:i A" }}</td>
      <td class="text-center">
        <a href="{% url 'procurement:pr_detail' pr.id %}" class="btn btn-sm btn-outline-dark">View</a>
      </td>
    </tr>
    {% empty %}
    <tr><td colspan="6" class="text-center text-muted">No purchase requests yet.</td></tr>
    {% endfor %}
  </tbody>
</table>

<!-- ====================== -->
<!-- JAVASCRIPT SECTION -->
<!-- ====================== -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const DEFAULT_STATUS = [
    ['draft','Draft'],['submitted','Submitted for Verification'],
    ['verified','Verified'],['endorsed','Endorsed for Approval'],['approved','Approved']
  ];
  const RFQ_FLOW_STATUS = [
    ['for_mop','For BACRes. MOP'],
    ['for_rfq','For RFQ Preparation'],
    ['for_award','For BACRes. Award'],
    ['for_po','For PO Preparation'],['po_issued','PO Issued'],
    ['delivered','Items Delivered'],['inspected','Inspected'],['closed','Closed']
  ];
  const PB_FLOW_STATUS = [
    ['for_pb','For Public Bidding'],['pre_bid','Pre-Bid Conference'],['bidding_open','Bidding Open'],
    ['bid_evaluation','Bid Evaluation'],['post_qualification','Post-Qualification'],
    ['bac_resolution','BAC Resolution Issued'],['notice_of_award','Notice of Award Issued'],
    ['contract_preparation','Contract Preparation'],['contract_signed','Contract Signed'],
    ['notice_to_proceed','Notice to Proceed Issued'],['delivery_completed','Delivery Completed'],
    ['payment_processing','Payment Processing'],['cancelled','Cancelled'],
    ['failed_bidding','Failed Bidding'],['disqualified','Disqualified Bidder']
  ];
  const RFQ_FLOW_MODES = new Set([
    'Direct Contracting','Direct Acquisition','Repeat Order','Small Value Procurement',
    'Negotiated Procurement','Direct Sales','Direct Procurement for Science, Technology and Innovation'
  ]);
  const PB_FLOW_MODES = new Set([
    'Competitive Bidding','Limited Source Bidding','Competitive Dialogue','Unsolicited Offer with Bid Matching'
  ]);

  function getCSRFToken() {
    const cookies = document.cookie.split(';');
    for (const cookie of cookies) {
      const [name, value] = cookie.trim().split('=');
      if (name === 'csrftoken') return decodeURIComponent(value);
    }
    return '';
  }

  function populateStatus(selectEl, mode, currentValue) {
    selectEl.innerHTML = '';
    const opt = document.createElement('option');
    opt.value = ''; opt.textContent = '— Select Status —';
    selectEl.appendChild(opt);

    let list = DEFAULT_STATUS;
    if (RFQ_FLOW_MODES.has(mode)) list = RFQ_FLOW_STATUS;
    else if (PB_FLOW_MODES.has(mode)) list = PB_FLOW_STATUS;

    list.forEach(([val, label]) => {
      const o = document.createElement('option');
      o.value = val; o.textContent = label;
      if (val === currentValue) o.selected = true;
      selectEl.appendChild(o);
    });
  }

  function flashHighlight(element) {
    element.classList.add('highlight-flash');
    setTimeout(() => element.classList.remove('highlight-flash'), 1200);
  }

  async function save(url, data) {
    await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
      body: JSON.stringify(data)
    });
  }

  document.querySelectorAll('.mode-select').forEach(modeSel => {
    const prId = modeSel.dataset.prId;
    const subSel = document.getElementById(modeSel.dataset.subSelectId);
    const row = document.getElementById(`pr-row-${prId}`);

    modeSel.addEventListener('change', e => {
      const val = e.target.value;
      if (val === 'Negotiated Procurement') subSel.style.display = 'block';
      else { subSel.style.display = 'none'; subSel.value = ''; }

      save(`/procurement/update_mode_ajax/${prId}/`, {
        mode_of_procurement: val,
        negotiated_type: subSel.value
      });

      const statusSel = document.querySelector(`.status-select[data-pr-id="${prId}"]`);
      if (statusSel) {
        populateStatus(statusSel, val, '');
        flashHighlight(row.querySelector('.status-column'));
      }
    });

    subSel.addEventListener('change', e => {
      save(`/procurement/update_mode_ajax/${prId}/`, {
        mode_of_procurement: modeSel.value,
        negotiated_type: subSel.value
      });
    });
  });

  document.querySelectorAll('.status-select').forEach(sel => {
    const prId = sel.dataset.prId;
    const mode = sel.dataset.mode || '';
    const current = sel.dataset.current || '';
    populateStatus(sel, mode, current);

    sel.addEventListener('change', e => {
      const newStatus = e.target.value;
      save(`/procurement/update_status_ajax/${prId}/`, { status: newStatus });
      flashHighlight(sel.closest('.status-column'));
    });
  });
});
</script>

<style>
.table-maroon { background-color: #800000; }
.text-maroon { color: #800000; }
.mode-column { max-width: 23ch; width: 23ch; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.mode-column select, .status-column select { width: 100%; font-size: 13px; padding: 3px 4px; }
.highlight-flash { background-color: #d4edda !important; transition: background-color 1.2s ease-out; }

.btn-maroon {
  background-color: #800000;
  color: #fff;
}
.btn-maroon:hover {
  background-color: #a00000;
  color: #fff;
}
</style>

{% endblock %}
