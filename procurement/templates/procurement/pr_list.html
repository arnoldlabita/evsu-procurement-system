{% extends "procurement/base.html" %}
{% load humanize %}
{% load tz %}
{% load group_tags %}

{% block content %}
<h2 class="text-maroon fw-bold mt-3">Purchase Requests</h2>

<table id="pr-table" class="table table-bordered align-middle mt-3 shadow-sm">
  <thead class="table-maroon text-white">
    <tr>
      <th>PR No.</th>
      <th>Requesting Office</th>
      <th>Status</th>
      <th>Mode of Procurement</th>
      <th>Last Update</th>
      <th class="text-center">Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for pr in prs %}
    <tr id="pr-row-{{ pr.pk }}">
      <td>{{ pr.pr_number|default:"(Draft)" }}</td>
      <td>{{ pr.office_section }}</td>
      <td class="status-cell">
        <span class="badge
          {% if pr.status == 'verified' %}bg-success
          {% elif pr.status == 'submitted' %}bg-primary
          {% elif pr.status == 'closed' %}bg-secondary
          {% else %}bg-warning text-dark{% endif %}">
          {{ pr.get_status_display }}
        </span>
      </td>

      <td class="mode-column">
        {% if user|has_group:"Procurement" %}
          <!-- Main Dropdown -->
          <select name="mode_of_procurement"
                  class="form-select form-select-sm mode-select"
                  data-pr-id="{{ pr.pk }}"
                  data-sub-select-id="submode-{{ pr.pk }}">
            <option value="">— Select Mode —</option>
            <option value="Competitive Bidding" {% if pr.mode_of_procurement == "Competitive Bidding" %}selected{% endif %}>Competitive Bidding</option>
            <option value="Limited Source Bidding" {% if pr.mode_of_procurement == "Limited Source Bidding" %}selected{% endif %}>Limited Source Bidding</option>
            <option value="Competitive Dialogue" {% if pr.mode_of_procurement == "Competitive Dialogue" %}selected{% endif %}>Competitive Dialogue</option>
            <option value="Unsolicited Offer with Bid Matching" {% if pr.mode_of_procurement == "Unsolicited Offer with Bid Matching" %}selected{% endif %}>Unsolicited Offer with Bid Matching</option>
            <option value="Direct Contracting" {% if pr.mode_of_procurement == "Direct Contracting" %}selected{% endif %}>Direct Contracting</option>
            <option value="Direct Acquisition" {% if pr.mode_of_procurement == "Direct Acquisition" %}selected{% endif %}>Direct Acquisition</option>
            <option value="Repeat Order" {% if pr.mode_of_procurement == "Repeat Order" %}selected{% endif %}>Repeat Order</option>
            <option value="Small Value Procurement" {% if pr.mode_of_procurement == "Small Value Procurement" %}selected{% endif %}>Small Value Procurement</option>
            <option value="Negotiated Procurement" {% if pr.mode_of_procurement == "Negotiated Procurement" %}selected{% endif %}>Negotiated Procurement</option>
            <option value="Direct Sales" {% if pr.mode_of_procurement == "Direct Sales" %}selected{% endif %}>Direct Sales</option>
            <option value="Direct Procurement for Science, Technology and Innovation" {% if pr.mode_of_procurement == "Direct Procurement for Science, Technology and Innovation" %}selected{% endif %}>Direct Procurement for Science, Technology and Innovation</option>
          </select>

          <!-- Negotiated Procurement Subtype -->
          <select name="negotiated_type"
                  id="submode-{{ pr.pk }}"
                  class="form-select form-select-sm mt-1 submode-select"
                  data-pr-id="{{ pr.pk }}"
                  {% if pr.mode_of_procurement != "Negotiated Procurement" %}style="display:none;"{% endif %}>
            <option value="">— Select Sub-Type —</option>
            <option value="Two Failed Biddings" {% if pr.negotiated_type == "Two Failed Biddings" %}selected{% endif %}>Two Failed Biddings</option>
            <option value="Emergency Cases" {% if pr.negotiated_type == "Emergency Cases" %}selected{% endif %}>Emergency Cases</option>
            <option value="Take-over of Contracts" {% if pr.negotiated_type == "Take-over of Contracts" %}selected{% endif %}>Take-over of Contracts</option>
            <option value="Adjacent or Contiguous" {% if pr.negotiated_type == "Adjacent or Contiguous" %}selected{% endif %}>Adjacent or Contiguous</option>
            <option value="Agency-to-Agency" {% if pr.negotiated_type == "Agency-to-Agency" %}selected{% endif %}>Agency-to-Agency</option>
            <option value="Scientific, Scholarly or Artistic Work, Exclusive Technology and Media Services" {% if pr.negotiated_type == "Scientific, Scholarly or Artistic Work, Exclusive Technology and Media Services" %}selected{% endif %}>Scientific, Scholarly or Artistic Work, Exclusive Technology and Media Services</option>
            <option value="Highly Technical Consultants" {% if pr.negotiated_type == "Highly Technical Consultants" %}selected{% endif %}>Highly Technical Consultants</option>
            <option value="Defense Cooperation Agreements and Inventory-Based Items" {% if pr.negotiated_type == "Defense Cooperation Agreements and Inventory-Based Items" %}selected{% endif %}>Defense Cooperation Agreements and Inventory-Based Items</option>
            <option value="Lease of Real Property and Venue" {% if pr.negotiated_type == "Lease of Real Property and Venue" %}selected{% endif %}>Lease of Real Property and Venue</option>
            <option value="Non-Government Organization (NGO) Participation" {% if pr.negotiated_type == "Non-Government Organization (NGO) Participation" %}selected{% endif %}>Non-Government Organization (NGO) Participation</option>
            <option value="Community Participation" {% if pr.negotiated_type == "Community Participation" %}selected{% endif %}>Community Participation</option>
            <option value="United Nations (UN) Agencies, International Organizations or International Financing Institutions" {% if pr.negotiated_type == "United Nations (UN) Agencies, International Organizations or International Financing Institutions" %}selected{% endif %}>United Nations (UN) Agencies, International Organizations or International Financing Institutions</option>
            <option value="Direct Retail Purchase of Petroleum Fuel, Oil and Lubricant Products, Electronic Charging Devices, and Online Subscriptions" {% if pr.negotiated_type == "Direct Retail Purchase of Petroleum Fuel, Oil and Lubricant Products, Electronic Charging Devices, and Online Subscriptions" %}selected{% endif %}>Direct Retail Purchase of Petroleum Fuel, Oil and Lubricant Products, Electronic Charging Devices, and Online Subscriptions</option>
          </select>
        {% else %}
          <!-- Read-only view for Requisitioners -->
          <span title="{{ pr.mode_of_procurement }}{% if pr.negotiated_type %} - {{ pr.negotiated_type }}{% endif %}">
            {{ pr.mode_of_procurement }}
            {% if pr.mode_of_procurement == "Negotiated Procurement" and pr.negotiated_type %}
              <br><small class="text-muted">{{ pr.negotiated_type }}</small>
            {% endif %}
          </span>
        {% endif %}
      </td>

      <td class="update-cell">{{ pr.last_update|localtime|date:"M d, Y h:i A" }}</td>
      <td class="text-center">
        <a href="{% url 'procurement:pr_detail' pr.id %}" class="btn btn-sm btn-outline-dark">View</a>
        {% if user|has_group:"Procurement" %}
        <button type="button"
                class="btn btn-sm btn-outline-maroon"
                data-bs-toggle="modal"
                data-bs-target="#statusModal"
                data-pr-id="{{ pr.pk }}"
                data-pr-number="{{ pr.pr_number|default:'(Draft)' }}">
          Update Status
        </button>
        {% endif %}
      </td>
    </tr>
    {% empty %}
    <tr><td colspan="6" class="text-center text-muted">No purchase requests yet.</td></tr>
    {% endfor %}
  </tbody>
</table>

<!-- ✅ Status Update Modal -->
<div class="modal fade" id="statusModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="statusForm" data-url="{% url 'procurement:update_pr_status' 0 %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title text-maroon" id="modalTitle">Update Status</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted small" id="modalSubtitle"></p>
          <label class="form-label">Staff Note</label>
          <textarea name="note" rows="3" class="form-control" placeholder="e.g. PO sent, goods received"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-maroon">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ✅ Bootstrap Toast for Feedback -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
  <div id="toast" class="toast align-items-center text-bg-success border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body" id="toast-body">Status updated successfully!</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<style>
.table-maroon { background-color: #800000; }
.text-maroon { color: #800000; }
.btn-maroon { background-color: #800000; color: white; border: none; }
.btn-maroon:hover { background-color: #a30000; }
.btn-outline-maroon { color: #800000; border: 1px solid #800000; }
.btn-outline-maroon:hover { background-color: #800000; color: white; }

/* Limit Mode of Procurement column width */
.mode-column {
  max-width: 23ch;
  width: 23ch;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  vertical-align: middle;
}
.mode-column select {
  max-width: 100%;
  width: 100%;
  font-size: 13px;
  padding: 3px 4px;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Toggle sub-dropdown dynamically
  document.querySelectorAll(".mode-select").forEach(select => {
    select.addEventListener("change", e => {
      const selectedValue = e.target.value;
      const prId = e.target.dataset.prId;
      const subSelect = document.getElementById(e.target.dataset.subSelectId);

      if (selectedValue === "Negotiated Procurement") {
        subSelect.style.display = "block";
      } else {
        subSelect.style.display = "none";
        subSelect.value = "";
      }

      saveProcurementMode(prId, selectedValue, subSelect.value);
    });
  });

  document.querySelectorAll(".submode-select").forEach(select => {
    select.addEventListener("change", e => {
      const prId = e.target.dataset.prId;
      const subtype = e.target.value;
      const mainMode = document.querySelector(`.mode-select[data-pr-id="${prId}"]`).value;
      saveProcurementMode(prId, mainMode, subtype);
    });
  });
});

// AJAX save function
function saveProcurementMode(prId, mode, subtype) {
  fetch(`/procurement/update_mode_ajax/${prId}/`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCookie("csrftoken")
    },
    body: JSON.stringify({
      mode_of_procurement: mode,
      negotiated_type: subtype
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      console.log(`✅ PR ${prId} updated: ${mode} ${subtype || ""}`);
    } else {
      alert("Failed to update mode: " + (data.error || "Unknown error"));
    }
  })
  .catch(err => console.error("Error:", err));
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    for (let cookie of document.cookie.split(";")) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + "=")) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>
{% endblock %}
